const { useState, useEffect } = React;

// --- CONFIGURATION ET DONNÉES PAR DÉFAUT ---
const translations = {
  fr: { title: "Réservation de casque", chooseSession: "Choisissez votre session", reserve: "Réserver maintenant", coachMode: "Mode Coach" },
  en: { title: "Headset Reservation", chooseSession: "Choose your session", reserve: "Reserve now", coachMode: "Coach Mode" },
  de: { title: "Kopfhörer-Reservierung", chooseSession: "Wähle deine Session", reserve: "Jetzt reservieren", coachMode: "Coach-Modus" }
};

const defaultConfig = {
  background_color: "#020617", gradient_color: "#3b0764", primary_color: "#d91cd2", secondary_color: "#8b5cf6",
  text_color: "#ffffff", font_family: "system-ui", font_size: 16, app_title: "Afroboost",
  app_subtitle: "Réservation de casque", concept_description: "Le concept Afroboost : cardio + danse afrobeat + casques audio immersifs.",
  choose_session_text: "Choisissez votre session", choose_offer_text: "Choisissez votre offre",
  user_info_text: "Vos informations", button_text: "Réserver maintenant"
};

const DEFAULT_COURSES = [
  { id: "wed", name: "Afroboost Silent – Session Cardio", weekday: 3, time: "18:30", locationName: "Rue des Vallangines 97, Neuchâtel" },
  { id: "sun", name: "Afroboost Silent – Sunday Vibes", weekday: 0, time: "18:30", locationName: "Rue des Vallangines 97, Neuchâtel" }
];

const DEFAULT_OFFERS = [
  { id: "single", name: "Cours à l'unité", price: 30, visible: true },
  { id: "pack10", name: "Carte 10 cours", price: 150, visible: true },
  { id: "sub1", name: "Abonnement 1 mois", price: 109, visible: true }
];

// --- FONCTIONS DE SAUVEGARDE ---
const load = (key, fallback) => {
  const raw = localStorage.getItem(key);
  return raw ? JSON.parse(raw) : fallback;
};
const save = (key, value) => localStorage.setItem(key, JSON.stringify(value));

// --- COMPOSANT PRINCIPAL ---
function App() {
  const [lang, setLang] = useState(load("af_lang", "fr"));
  const [config, setConfig] = useState(load("af_config", defaultConfig));
  const [coachMode, setCoachMode] = useState(localStorage.getItem("isCoachLoggedIn") === "true");
  const [showCoachLogin, setShowCoachLogin] = useState(false);
  
  // Champs de connexion
  const [loginEmail, setLoginEmail] = useState("");
  const [loginPassword, setLoginPassword] = useState("");
  const [loginError, setLoginError] = useState("");

  const [courses, setCourses] = useState(load("af_courses", DEFAULT_COURSES));
  const [offers, setOffers] = useState(load("af_offers", DEFAULT_OFFERS));
  const [reservations, setReservations] = useState(load("af_reservations", []));

  useEffect(() => { save("af_config", config); }, [config]);
  useEffect(() => { save("af_reservations", reservations); }, [reservations]);

  // FONCTION DE CONNEXION COACH
  const handleLogin = (e) => {
    e.preventDefault();
    // Identifiants par défaut
    if (loginEmail === "coach@afroboost.com" && loginPassword === "Afroboost2026") {
      localStorage.setItem("isCoachLoggedIn", "true");
      setCoachMode(true);
      setShowCoachLogin(false);
      setLoginError("");
    } else {
      setLoginError("Email ou mot de passe incorrect.");
    }
  };

  // FONCTION MOT DE PASSE OUBLIÉ
  const handleForgotPw = () => {
    const subject = encodeURIComponent("Réinitialisation Mot de Passe Afroboost");
    const body = encodeURIComponent("Bonjour, je souhaite réinitialiser mon accès coach Afroboost.");
    window.location.href = `mailto:admin@afroboost.com?subject=${subject}&body=${body}`;
    alert("Votre application de messagerie va s'ouvrir pour envoyer une demande de réinitialisation.");
  };

  const logout = () => {
    localStorage.removeItem("isCoachLoggedIn");
    setCoachMode(false);
  };

  if (showCoachLogin) {
    return (
      <div className="w-full min-h-screen flex items-center justify-center p-6" style={{background: config.background_color}}>
        <div className="glass rounded-xl p-8 max-w-md w-full neon-border">
          <h2 className="text-2xl font-bold mb-6 text-center" style={{color: config.text_color}}>Accès Coach</h2>
          <form onSubmit={handleLogin}>
            <input type="email" placeholder="Email" value={loginEmail} onChange={e => setLoginEmail(e.target.value)} className="w-full p-3 mb-4 rounded glass text-white" required />
            <input type="password" placeholder="Mot de passe" value={loginPassword} onChange={e => setLoginPassword(e.target.value)} className="w-full p-3 mb-4 rounded glass text-white" required />
            {loginError && <p className="text-red-500 text-sm mb-4">{loginError}</p>}
            <button type="submit" className="btn-primary w-full py-3 rounded-lg font-bold mb-4">Se connecter</button>
            <button type="button" onClick={handleForgotPw} className="w-full text-sm opacity-70 mb-4 hover:opacity-100" style={{color: config.text_color}}>Mot de passe oublié ?</button>
            <button type="button" onClick={() => setShowCoachLogin(false)} className="w-full py-2 rounded glass" style={{color: config.text_color}}>Retour au site</button>
          </form>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen p-6 text-center" style={{background: `radial-gradient(circle at top, ${config.gradient_color} 0%, ${config.background_color} 45%)`, color: config.text_color}}>
      <h1 className="text-5xl font-bold mb-4">{config.app_title}</h1>
      <p className="max-w-xl mx-auto opacity-80 mb-10">{config.concept_description}</p>
      
      {coachMode ? (
        <div className="glass p-6 rounded-xl max-w-4xl mx-auto text-left">
          <div className="flex justify-between mb-6">
            <h2 className="text-2xl font-bold">Tableau de bord Coach</h2>
            <button onClick={logout} className="px-4 py-2 bg-red-500 rounded font-bold">Déconnexion</button>
          </div>
          <p>Bienvenue dans votre gestionnaire. Vos réservations apparaîtront ici.</p>
        </div>
      ) : (
        <button className="btn-primary px-10 py-4 rounded-xl font-bold text-xl" onClick={() => alert('Ouverture du planning...')}>
          Réserver mon casque
        </button>
      )}

      <footer className="mt-20 opacity-30 text-xs" onDoubleClick={() => setShowCoachLogin(true)}>
        © Afroboost 2026 - Double-cliquez ici pour l'Espace Coach
      </footer>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
